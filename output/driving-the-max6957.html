<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Driving the MAX6957</title>
    <link rel="stylesheet" href="/theme/css/main.css">
</head>
<body>
  <header class="site-header" role="banner">

    <div class="wrapper"><a class="site-title" rel="author" href="/">Dean Nevins</a><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
              </svg>
            </span>
          </label>
  
          <div class="trigger">
            <a class="page-link" href="/pages/about.html">About</a>
            <a class="page-link" href="/category/Blog.html">Blog</a>
            <a class="page-link" href="/category/Clock.html">Clock</a>
            <a class="page-link" href="/category/Pinball.html">Pinball</a>
          </div>
        </nav>
      </div>
  </header>
    <main class="page-content" aria-label="Content">
<div class="wrapper">
    <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
        <header class="post-header">
            <h1 class="post-title p-name" itemprop="name headline">Driving the MAX6957</h1>
            <div class="opposite-sides post-meta">
                    <time class="opposite-sides left" datetime="2015-02-21 00:00:00-08:00" itemprop="datePublished">February 2, 2015
                    </time> 
                    <div class="opposite-sides right">Category: Pinball</div>
            </div>
        </header>

        <!-- Article stream navigation top -->
        <div class="article-stream">

            <div class="article-steam left">
                <a href="/investigating-the-spi-driver.html">
                    << Investigating the SPI driver
                </a>
            </div>
            
            <div class="article-steam right">
                <a href="/first-light.html">
                    First Light >>
                </a>
            </div>
            
        </div>

        <!-- Article content -->
        <div class="post-content e-content" itemprop="articleBody">
            <h1>Writing to the SPI Interface</h1>
<p>The SPI interface is working on the Raspberry Pi and so I'm getting ready to
send some information to the <a href="http://datasheets.maximintegrated.com/en/ds/MAX6957.pdf">4-Wire-Intefaced 20-Port LED Display Driver and
I/O Expander (MAX6957)</a>, called the 6957 from now on. The issue that is
mentioned from the data sheet is that the 6957 uses 16 bit words but the driver
only uses eight bit words. You can change the word size but then you get an
error when you try to send something. I guess those parameters are primarily
decorative.</p>
<p>In order to test if the Raspberry Pi's SPI interface would work for the 6957 I
wrote some test code (which I'll put up later) to send out the number 0xFFAA. I
wanted to see what was actually coming out on the bus so I looked at it with the
wonderful logic analyzer by <a href="https://www.saleae.com">Saleae</a>. A screenshot is shown below.</p>
<p><img alt="Logic analyzer shows 16 bit write as two 8 bit writes." src="/images/16BitSPIWrite.png"></p>
<p>You can see that we get two discrete writes of the data. But! The good news is
that the chip select is held down the entire time. Other than some weird clock
skew between bytes we can write a 16-bit word! Eagle eyes will notice though
that the MSB for each work comes out properly but the bytes themselves are
reversed from the perspective of a <a href="https://en.wikipedia.org/wiki/Endianness#Big-endian">big endian</a> write. A byte flip later and
I send out the data byte 0xF5A5 and it appears in the proper order. The logic
analyzer output is shown below.</p>
<p><img alt="Logic analyzer shows 16 bit write as two 8 bit big-endian writes." src="/images/16BitSPIWriteFlippedBytes.png"></p>
<p>It works perfect. Now to write some code to talk to the 6957.</p>
<h1>Flashing an LED</h1>
<p>I want to write a simple program to flash an LED driven by the 6957 connected
to a single LED. The circuit that I come up with is shown below.</p>
<p><img alt="SPI to LED test circuit." src="/images/SPILEDTestCircuit.png"></p>
<p>The labels shown on the connection are the same as the signal names given by the
<a href="http://www.adafruit.com/products/2028">Adafruit T-Cobbler Plus</a>. Since the 6957 controls all of the current
limiting you don't need a resistor. The sequence of codes to light port 22 (P22)
is the following</p>
<div class="highlight"><pre><span></span><code><span class="mf">0</span><span class="n">x0D00</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">Configures</span><span class="w"> </span><span class="n">P22</span><span class="w"> </span><span class="p">(</span><span class="ow">and</span><span class="w"> </span><span class="n">others</span><span class="p">)</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">LED</span><span class="w"> </span><span class="n">driver</span><span class="mf">.</span>
<span class="mf">0</span><span class="n">x36FF</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">Turns</span><span class="w"> </span><span class="kr">on</span><span class="w"> </span><span class="n">P22</span>
<span class="mf">0</span><span class="n">x020A</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">global</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="kr">cont</span><span class="n">rol</span><span class="w"> </span><span class="kr">to</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="mf">16</span><span class="n">mA</span>
<span class="mf">0</span><span class="n">x0401</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">Take</span><span class="w"> </span><span class="mf">6957</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">shutdown</span><span class="w"> </span><span class="n">mode</span>
</code></pre></div>

<p>I wrote an SPI driver based upon the test program I used earlier and then I
used that to write a short test program that flashes an LED every second. After
some playing around it works! Admittedly it's a very expensive LED flasher!</p>
<p><img alt="Flashing an LED." src="/images/SPILEDHardwareTest.jpg"></p>
<h1>What's Next?</h1>
<p>Now that I've got an LED working it's time to use the 6957 for what it is
designed to do; drive a multi-segmented LED display!</p>
        </div>

        <a class="u-url" href="/projects/clock/2025/03/04/introducing-esp32-s3.html" hidden></a>

        <!-- Article stream navigation bottom -->
        <!-- Article stream navigation top -->
        <div class="article-stream">

            <div class="article-steam left">
                <a href="/investigating-the-spi-driver.html">
                    << Investigating the SPI driver
                </a>
            </div>
            
            <div class="article-steam right">
                <a href="/first-light.html">
                    First Light >>
                </a>
            </div>

    </article>

</div>
    </main>
    <footer class="site-footer h-card">
        <data class="u-url" href="/"></data>

        <div class="wrapper">
            <div class="footer-col-wrapper">
                <div class="footer-col footer-col-1">
                    <ul class="contact-list">
                        <li class="p-name">Dean Nevins</li>
                    </ul>
                </div>

                <div class="footer-col footer-col-2">
                    <ul class="social-media-list">
                        <li>
                            <a href="https://github.com/devnevins">
<svg width="18px" height="18px" style="fill: #828282;" viewBox="0 0 21 21" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Dribbble-Light-Preview" transform="translate(-140.000000, -7559.000000)" fill="#000000">
            <g id="icons" transform="translate(56.000000, 160.000000)">
                <path d="M94,7399 C99.523,7399 104,7403.59 104,7409.253 C104,7413.782 101.138,7417.624 97.167,7418.981 C96.66,7419.082 96.48,7418.762 96.48,7418.489 C96.48,7418.151 96.492,7417.047 96.492,7415.675 C96.492,7414.719 96.172,7414.095 95.813,7413.777 C98.04,7413.523 100.38,7412.656 100.38,7408.718 C100.38,7407.598 99.992,7406.684 99.35,7405.966 C99.454,7405.707 99.797,7404.664 99.252,7403.252 C99.252,7403.252 98.414,7402.977 96.505,7404.303 C95.706,7404.076 94.85,7403.962 94,7403.958 C93.15,7403.962 92.295,7404.076 91.497,7404.303 C89.586,7402.977 88.746,7403.252 88.746,7403.252 C88.203,7404.664 88.546,7405.707 88.649,7405.966 C88.01,7406.684 87.619,7407.598 87.619,7408.718 C87.619,7412.646 89.954,7413.526 92.175,7413.785 C91.889,7414.041 91.63,7414.493 91.54,7415.156 C90.97,7415.418 89.522,7415.871 88.63,7414.304 C88.63,7414.304 88.101,7413.319 87.097,7413.247 C87.097,7413.247 86.122,7413.234 87.029,7413.87 C87.029,7413.87 87.684,7414.185 88.139,7415.37 C88.139,7415.37 88.726,7417.2 91.508,7416.58 C91.513,7417.437 91.522,7418.245 91.522,7418.489 C91.522,7418.76 91.338,7419.077 90.839,7418.982 C86.865,7417.627 84,7413.783 84,7409.253 C84,7403.59 88.478,7399 94,7399" id="github-[#142]"></path>
            </g>
        </g>
    </g>
</svg>                                <span class="username">devnevins</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="footer-col footer-col-3">
                    <p>My space on the internet. Not myspace; you know what I mean. Projects, opinions, and such.</p>
                </div>
            </div>

        </div>

    </footer>
</body>

</html>